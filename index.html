<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Poin Gaji Bulanan (JSON)</title>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 30px;
      background: #f4f6f9;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #222;
      font-size: 28px;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    th, td {
      padding: 12px 14px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #007bff;
      color: white;
      font-weight: 500;
      font-size: 15px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    input {
      width: 95%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      outline: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    input:focus {
      border-color: #007bff;
      box-shadow: 0 0 4px rgba(0,123,255,0.3);
    }

    button {
      padding: 8px 15px;
      margin: 5px 4px 0 0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .add { background: #28a745; color: white; }
    .utangBtn { background: #6f42c1; color: white; }
    .export { background: #ffc107; color: #222; }
    .importBtn { background: #20c997; color: white; }
    .save { background: #17a2b8; color: white; }
    .clear { background: #dc3545; color: white; }

    .filename {
      margin: 15px 0;
    }

    .filename input {
      width: 250px;
    }

    .result {
      margin-top: 25px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .result h3 {
      margin: 10px 0;
      color: #007bff;
    }

    .bersih {
      font-size: 22px;
      font-weight: 700;
      color: #28a745;
      margin-top: 12px;
    }

    .duplikat {
      border: 2px solid #dc3545 !important;
      background: #f8d7da;
    }

    .toolbar {
      text-align: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Kalkulator Poin Gaji Bulanan</h1>

  <div class="toolbar">
    <button class="add" onclick="tambahBaris()">+ Tambah Hari</button>
    <button class="utangBtn" onclick="tambahUtang()">+ Tambah Utang</button>
    <button class="export" onclick="exportJSON()">â¬‡ Download JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importJSON(event)">
    <button class="importBtn" onclick="document.getElementById('importFile').click()">â¬† Upload JSON</button>
    <button class="save" onclick="saveData()">ðŸ’¾ Save</button>
    <button class="clear" onclick="clearData()">ðŸ—‘ Clear</button>
  </div>

  <table id="tabelInput">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Poin Per-Pasien</th>
        <th>Catatan</th>
        <th>Poin Jumlah Pasien</th>
        <th>Poin Transport</th>
        <th>Total Poin Harian</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <table id="tabelUtang" style="display:none;">
    <thead>
      <tr>
        <th>Tanggal Utang</th>
        <th>Total Utang (Rp)</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="filename">
    <label>Nama File: </label>
    <input type="text" id="namaFile" placeholder="rekap_poin_gaji.json">
  </div>

  <div id="hasil" class="result" style="display:none;"></div>

<script>
function parseNumberString(s) {
  if (s === undefined || s === null) return 0;
  s = String(s).trim();
  if (s === "") return 0;
  s = s.replace(/rp/ig, "").trim();
  s = s.replace(/\s/g, "");
  s = s.replace(/(,-|.\-)$/,"");
  if (s.indexOf('.') > -1 && s.indexOf(',') > -1) {
    s = s.replace(/\./g, '').replace(',', '.');
  } else if (s.indexOf(',') > -1 && s.indexOf('.') === -1) {
    s = s.replace(',', '.');
  } else {
    s = s.replace(/\./g, '');
  }
  s = s.replace(/[^\d\-.]/g, '');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function tambahBaris(data = {}) {
  const tbody = document.querySelector("#tabelInput tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date" value="${data.tanggal || ''}" oninput="hitungTotal()"></td>
    <td><input type="number" step="0.01" value="${data.perPasien || ''}" placeholder="Poin per-pasien" oninput="hitungTotal()"></td>
    <td><input type="text" value="${data.catatan || ''}" placeholder="Catatan (opsional)"></td>
    <td><input type="number" step="0.01" value="${data.jumlahPasien || ''}" placeholder="Poin jumlah pasien" oninput="hitungTotal()"></td>
    <td><input type="number" step="0.01" value="${data.transport || 25}" oninput="hitungTotal()"></td>
    <td class="total-harian">0.00</td>
    <td><button onclick="hapusBaris(this)">Hapus</button></td>
  `;
  tbody.appendChild(tr);
  hitungTotal();
}

function tambahUtang(data = {}) {
  document.getElementById("tabelUtang").style.display = "table";
  const tbody = document.querySelector("#tabelUtang tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date" value="${data.tanggal || ''}" oninput="hitungTotal()"></td>
    <td><input type="text" value="${data.total || ''}" placeholder="Total utang (angka, tanpa Rp)" oninput="hitungTotal()"></td>
    <td><button onclick="hapusBaris(this)">Hapus</button></td>
  `;
  tbody.appendChild(tr);
  hitungTotal();
}

function hapusBaris(btn) {
  if (confirm("Apakah Anda yakin ingin menghapus baris ini?")) {
    btn.parentElement.parentElement.remove();
    hitungTotal();
  }
}

function hitungTotal() {
  const rows = document.querySelectorAll("#tabelInput tbody tr");
  let totalPerPasien = 0, totalJumlahPasien = 0, totalTransport = 0;
  let tanggalSet = new Set();

  rows.forEach(r => {
    const tanggalInput = r.children[0].querySelector("input");
    const tanggal = tanggalInput.value;
    tanggalInput.classList.remove("duplikat");

    if (tanggal && tanggalSet.has(tanggal)) {
      alert(`Tanggal ${tanggal} sudah ada! Silakan ganti tanggal.`);
      tanggalInput.value = "";
      tanggalInput.classList.add("duplikat");
      return;
    }
    if (tanggal) tanggalSet.add(tanggal);

    const perPasien = parseFloat(r.children[1].querySelector("input").value) || 0;
    const jumlahPasien = parseFloat(r.children[3].querySelector("input").value) || 0;
    const transport = parseFloat(r.children[4].querySelector("input").value) || 0;

    totalPerPasien += perPasien;
    totalJumlahPasien += jumlahPasien;
    totalTransport += transport;

    const hasilHarian = (perPasien * 0.4) + jumlahPasien + transport;
    r.querySelector(".total-harian").textContent = hasilHarian.toFixed(2);
  });

  const hasilPerPasien = totalPerPasien * 0.4;
  const totalAkhir = hasilPerPasien + totalJumlahPasien + totalTransport;

  const rowsUtang = document.querySelectorAll("#tabelUtang tbody tr");
  let totalUtang = 0;
  rowsUtang.forEach(r => {
    const raw = r.children[1].querySelector("input").value;
    const utang = parseNumberString(raw);
    totalUtang += utang;
  });

  const totalGajiRp = Math.round(totalAkhir * 1000);
  const gajiBersih = totalGajiRp - Math.round(totalUtang);

  const hasilDiv = document.getElementById("hasil");
  hasilDiv.style.display = "block";
  hasilDiv.innerHTML = `
    <p><b>Total Poin Per-Pasien (setelah 40%):</b> ${hasilPerPasien.toFixed(2)}</p>
    <p><b>Total Poin Jumlah Pasien:</b> ${totalJumlahPasien.toFixed(2)}</p>
    <p><b>Total Poin Transport:</b> ${totalTransport.toFixed(2)}</p>
    <hr>
    <h3>Total Poin Gaji Bulan Ini: ${totalAkhir.toFixed(2)}</h3>
    <p><b>Total Gaji (Rp):</b> Rp ${totalGajiRp.toLocaleString("id-ID")}</p>
    <p><b>Total Utang (Rp):</b> Rp ${Math.round(totalUtang).toLocaleString("id-ID")}</p>
    <p class="bersih">Total Gaji Bersih (Rp): Rp ${gajiBersih.toLocaleString("id-ID")}</p>
  `;

  hasilDiv.dataset.rekap = JSON.stringify({
    hasilPerPasien: hasilPerPasien.toFixed(2),
    totalJumlahPasien: totalJumlahPasien.toFixed(2),
    totalTransport: totalTransport.toFixed(2),
    totalAkhir: totalAkhir.toFixed(2),
    totalUtang: Math.round(totalUtang),
    gajiBersih: gajiBersih
  });
}

function exportJSON() {
  const rows = document.querySelectorAll("#tabelInput tbody tr");
  const rowsUtang = document.querySelectorAll("#tabelUtang tbody tr");
  let data = { hari: [], utang: [], rekap: {} };

  rows.forEach(r => {
    data.hari.push({
      tanggal: r.children[0].querySelector("input").value,
      perPasien: r.children[1].querySelector("input").value,
      catatan: r.children[2].querySelector("input").value,
      jumlahPasien: r.children[3].querySelector("input").value,
      transport: r.children[4].querySelector("input").value
    });
  });

  rowsUtang.forEach(r => {
    data.utang.push({
      tanggal: r.children[0].querySelector("input").value,
      total: r.children[1].querySelector("input").value
    });
  });

  const hasilDiv = document.getElementById("hasil");
  if (hasilDiv.dataset.rekap) {
    data.rekap = JSON.parse(hasilDiv.dataset.rekap);
  }

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");

  let namaFile = document.getElementById("namaFile").value.trim();
  if (namaFile === "") namaFile = "rekap_poin_gaji.json";
  if (!namaFile.endsWith(".json")) namaFile += ".json";

  a.href = url;
  a.download = namaFile;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!file.name.toLowerCase().endsWith('.json')) {
    alert("Mohon pilih file JSON (.json).");
    event.target.value = "";
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);

      document.querySelector("#tabelInput tbody").innerHTML = "";
      document.querySelector("#tabelUtang tbody").innerHTML = "";
      document.getElementById("tabelUtang").style.display = "none";

      if (data.hari) data.hari.forEach(d => tambahBaris(d));
      if (data.utang && data.utang.length > 0) data.utang.forEach(u => tambahUtang(u));

      if (data.rekap) {
        document.getElementById("hasil").dataset.rekap = JSON.stringify(data.rekap);
      }

      hitungTotal();
      alert("Import JSON berhasil!");
    } catch (err) {
      alert("File JSON tidak valid!");
    }
    event.target.value = "";
  };
  reader.readAsText(file, "UTF-8");
}

function saveData() {
  const rows = document.querySelectorAll("#tabelInput tbody tr");
  const rowsUtang = document.querySelectorAll("#tabelUtang tbody tr");
  let data = { hari: [], utang: [] };

  rows.forEach(r => {
    data.hari.push({
      tanggal: r.children[0].querySelector("input").value,
      perPasien: r.children[1].querySelector("input").value,
      catatan: r.children[2].querySelector("input").value,
      jumlahPasien: r.children[3].querySelector("input").value,
      transport: r.children[4].querySelector("input").value
    });
  });

  rowsUtang.forEach(r => {
    data.utang.push({
      tanggal: r.children[0].querySelector("input").value,
      total: r.children[1].querySelector("input").value
    });
  });

  localStorage.setItem("rekapPoinGaji", JSON.stringify(data));
  alert("Data berhasil disimpan!");
}

function clearData() {
  if (confirm("Yakin ingin menghapus semua data tersimpan?")) {
    localStorage.removeItem("rekapPoinGaji");
    document.querySelector("#tabelInput tbody").innerHTML = "";
    document.querySelector("#tabelUtang tbody").innerHTML = "";
    document.getElementById("tabelUtang").style.display = "none";
    document.getElementById("hasil").style.display = "none";
    alert("Data terhapus.");
  }
}

window.onload = function() {
  const saved = localStorage.getItem("rekapPoinGaji");
  if (saved) {
    try {
      const data = JSON.parse(saved);
      if (data.hari) data.hari.forEach(d => tambahBaris(d));
      if (data.utang && data.utang.length > 0) data.utang.forEach(u => tambahUtang(u));
    } catch (e) {
      console.error("Gagal load:", e);
    }
  }
};
</script>
</body>
</html>
